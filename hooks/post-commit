#!/bin/bash
# Git post-commit hook for tag-only semantic versioning
# Place this file in .git/hooks/post-commit and make it executable

# Change to the repository root
cd "$(git rev-parse --show-toplevel)"

# Check if we're on the main branch
current_branch=$(git rev-parse --abbrev-ref HEAD)
if [ "$current_branch" != "main" ]; then
    echo "Skipping auto-tagging: not on main branch"
    exit 0
fi

# Check if this is a merge commit (skip auto-versioning for merges)
if git log -1 --merges HEAD | grep -q "commit"; then
    echo "Skipping auto-tagging: merge commit detected"
    exit 0
fi

# Check if current commit already has a tag
if git tag --points-at HEAD | grep -q "v"; then
    echo "Skipping auto-tagging: current commit already has a version tag"
    exit 0
fi

# Run conventional commit analysis
echo "🔍 Analyzing commits for version tag..."

if python3 utils/semver.py analyze | grep -q "Recommended version bump: none"; then
    echo "✅ No version tag needed"
    exit 0
fi

echo "🚀 Creating version tag based on conventional commits..."
python3 utils/semver.py auto

# Check if tagging was successful
if [ $? -eq 0 ]; then
    echo "✅ Version tag created successfully"
    echo "💡 Push tags with: git push origin --tags"
else
    echo "❌ Version tag creation failed"
    exit 1
fi
